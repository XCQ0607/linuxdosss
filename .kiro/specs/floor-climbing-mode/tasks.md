# Implementation Plan: Floor Climbing Mode

## Overview

本实现计划将爬楼模式功能集成到现有的 Linux.do 论坛助手 GUI 版本（linux_do_gui.py）中。爬楼模式专门针对运营反馈板块的帖子进行智能阅读，通过检测阅读状态指示器确保每条回复被完全阅读。

实现语言：Python 3
主要依赖：DrissionPage, Tkinter

## Tasks

- [ ] 1. 扩展配置和数据结构
  - 在 CFG 字典中添加爬楼模式配置项
  - 定义爬楼模式相关的数据结构（字典格式）
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 2. 实现阅读进度获取功能
  - [ ] 2.1 实现 `get_reading_progress()` 方法
    - 访问 connect.linux.do 页面
    - 使用 JavaScript 提取阅读进度数据
    - 返回包含已读话题数、阅读时长等信息的字典
    - _Requirements: 2.1, 2.2, 2.3_

  - [ ]* 2.2 编写 `get_reading_progress()` 的单元测试
    - 测试正常获取进度的情况
    - 测试页面加载失败的情况
    - 测试数据解析失败的情况
    - _Requirements: 2.4_

- [ ] 3. 实现运营反馈板块帖子获取功能
  - [ ] 3.1 实现 `fetch_feedback_topics()` 方法
    - 访问运营反馈板块 URL
    - 使用 JavaScript 获取当前可见帖子列表
    - 实现无限滚动加载更多帖子
    - 过滤已爬楼的帖子
    - 返回帖子列表（包含 url, title, reply_count）
    - _Requirements: 1.1, 1.2, 1.3, 1.6_

  - [ ]* 3.2 编写属性测试：帖子列表获取完整性
    - **Property 1: 帖子列表获取完整性**
    - **Validates: Requirements 1.2, 1.4, 1.5**
    - 生成随机的最大帖子数量
    - 验证获取的帖子数量不超过配置值
    - 验证所有帖子都包含必需字段

- [ ] 4. 实现无限滚动处理功能
  - [ ] 4.1 实现 `handle_infinite_scroll()` 方法
    - 检测页面是否滚动到底部
    - 等待加载指示器出现
    - 等待新内容加载完成
    - 判定是否还有更多内容
    - 支持 "topic" 和 "reply" 两种滚动类型
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

  - [ ]* 4.2 编写属性测试：无限滚动触发正确性
    - **Property 4: 无限滚动触发正确性**
    - **Validates: Requirements 7.1, 7.2, 7.4**
    - 模拟滚动到底部的场景
    - 验证系统等待新内容加载
    - 验证正确判定是否有更多内容

- [ ] 5. 实现阅读状态指示器检测功能
  - [ ] 5.1 实现 `detect_read_state()` 方法
    - 使用 CSS 选择器 `.read-state.read` 查找指示器元素
    - 检测蓝色圆点 SVG 是否存在
    - 检测指示器是否可见
    - 返回所有可见回复的指示器状态列表
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.6_

  - [ ]* 5.2 编写属性测试：阅读状态指示器检测准确性
    - **Property 2: 阅读状态指示器检测准确性**
    - **Validates: Requirements 4.1, 4.2, 4.3**
    - 生成随机的指示器状态（存在/不存在，可见/不可见）
    - 验证检测结果与实际状态一致

- [ ] 6. 实现智能爬楼滚动功能
  - [ ] 6.1 实现 `scroll_with_indicator()` 方法
    - 滚动到下一条回复
    - 检测当前回复的阅读状态指示器
    - 如果指示器存在，暂停并等待其消失
    - 在每条回复停留随机时间（2-5秒）
    - 记录已读回复数量
    - 处理滚动到底部的情况
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.9_

  - [ ]* 6.2 编写属性测试：智能滚动等待策略
    - **Property 3: 智能滚动等待策略**
    - **Validates: Requirements 3.4, 3.5**
    - 模拟检测到指示器的场景
    - 验证系统暂停滚动
    - 验证系统等待指示器消失后继续

- [ ] 7. 实现单个帖子爬楼功能
  - [ ] 7.1 实现 `climb_topic()` 方法
    - 访问帖子 URL
    - 等待页面加载完成
    - 调用 `scroll_with_indicator()` 进行智能滚动
    - 处理无限滚动加载更多回复
    - 记录爬楼统计数据
    - 处理错误情况（页面加载超时等）
    - _Requirements: 3.7, 3.8, 8.1, 8.2_

  - [ ]* 7.2 编写单元测试：单个帖子爬楼
    - 测试正常爬楼流程
    - 测试页面加载超时的处理
    - 测试指示器检测失败的处理

- [ ] 8. 实现进度验证功能
  - [ ] 8.1 实现 `verify_progress()` 方法
    - 再次调用 `get_reading_progress()` 获取爬楼后进度
    - 计算进度差异（已读话题增量、阅读时长增量）
    - 生成进度变化报告
    - 记录到日志
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [ ]* 8.2 编写属性测试：进度验证一致性
    - **Property 5: 进度验证一致性**
    - **Validates: Requirements 5.1, 5.2, 5.3**
    - 模拟爬楼 N 个帖子
    - 验证爬楼后进度 >= 爬楼前进度

- [ ] 9. 实现爬楼会话主流程
  - [ ] 9.1 实现 `run_floor_climbing_session()` 方法
    - 检查登录状态
    - 获取初始阅读进度
    - 调用 `fetch_feedback_topics()` 获取帖子列表
    - 随机选择配置数量的帖子进行爬楼
    - 对每个帖子调用 `climb_topic()`
    - 在帖子之间添加随机等待时间（防风控）
    - 调用 `verify_progress()` 验证进度变化
    - 生成爬楼统计报告
    - 保存状态到文件
    - _Requirements: 2.5, 5.5, 9.1, 9.2, 9.3, 9.4, 9.5, 10.1, 10.2, 10.3_

  - [ ]* 9.2 编写属性测试：已爬楼帖子过滤
    - **Property 6: 已爬楼帖子过滤**
    - **Validates: Requirements 1.6**
    - 生成随机帖子列表
    - 随机标记部分帖子为已爬楼
    - 验证过滤后的列表不包含已爬楼帖子

  - [ ]* 9.3 编写属性测试：防风控随机化
    - **Property 8: 防风控随机化**
    - **Validates: Requirements 10.1, 10.2**
    - 生成多次操作的等待时间
    - 验证所有等待时间在配置范围内
    - 验证等待时间具有随机性

- [ ] 10. Checkpoint - 确保核心功能测试通过
  - 确保所有核心爬楼功能测试通过，询问用户是否有问题

- [ ] 11. 扩展 GUI 界面
  - [ ] 11.1 在 GUI 类中添加爬楼模式界面元素
    - 添加爬楼模式开关（Checkbutton）
    - 添加爬楼配置面板（帖子数量、滚动速度等）
    - 添加爬楼统计显示区域
    - 更新布局以容纳新元素
    - _Requirements: 6.6_

  - [ ] 11.2 修改开始按钮点击事件
    - 检查爬楼模式开关状态
    - 根据状态选择运行普通模式或爬楼模式
    - 启动对应的线程
    - _Requirements: 6.6_

  - [ ] 11.3 实现爬楼模式运行线程
    - 创建 `run_floor_climbing()` 方法
    - 调用 Bot 的 `run_floor_climbing_session()`
    - 更新 GUI 日志和统计显示
    - 处理线程异常

- [ ] 12. 扩展状态管理
  - [ ] 12.1 在状态文件中添加爬楼模式记录
    - 添加 `climbed_topics` 列表
    - 添加 `floor_climbing_stats` 字典
    - 实现状态的保存和加载
    - _Requirements: 1.6_

  - [ ] 12.2 实现已爬楼帖子的查询和记录
    - 实现检查帖子是否已爬楼的逻辑
    - 实现添加已爬楼帖子的逻辑
    - 确保状态持久化

- [ ] 13. 实现错误处理和日志记录
  - [ ] 13.1 添加错误处理逻辑
    - 处理页面加载超时
    - 处理指示器检测失败
    - 处理网络连接中断
    - 处理登录状态失效
    - 实现连续失败计数和停止机制
    - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

  - [ ] 13.2 完善日志记录
    - 记录每个爬楼帖子的详细信息
    - 记录错误和警告
    - 生成爬楼统计报告
    - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_

  - [ ]* 13.3 编写属性测试：错误恢复机制
    - **Property 7: 错误恢复机制**
    - **Validates: Requirements 8.1, 8.2, 8.5**
    - 模拟各种错误场景
    - 验证系统记录错误并继续处理
    - 验证系统不会终止整个会话

- [ ] 14. 集成测试和调试
  - [ ] 14.1 运行完整的爬楼流程测试
    - 启动 GUI 应用
    - 启用爬楼模式
    - 点击开始按钮
    - 验证爬楼流程正常执行
    - 检查日志输出
    - 验证进度变化

  - [ ] 14.2 测试边界情况
    - 测试运营反馈板块无新帖子的情况
    - 测试所有帖子都已爬楼的情况
    - 测试网络异常的情况
    - 测试登录失效的情况

  - [ ] 14.3 性能和防风控测试
    - 验证操作间隔的随机性
    - 验证滚动速度的合理性
    - 验证不会触发异常检测

- [ ] 15. Final Checkpoint - 确保所有测试通过
  - 确保所有测试通过，询问用户是否有问题

## Notes

- 任务标记 `*` 的为可选测试任务，可根据需要跳过以加快开发速度
- 每个任务都引用了具体的需求编号，确保可追溯性
- Checkpoint 任务用于在关键节点验证功能正确性
- 属性测试使用 `hypothesis` 库，每个测试至少运行 100 次迭代
- 单元测试使用 Python 的 `unittest` 框架
- 所有代码修改都在现有的 `linux_do_gui.py` 文件中进行
